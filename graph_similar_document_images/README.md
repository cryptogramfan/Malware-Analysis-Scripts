# graph_similar_document_images.py
 A script that extracts embedded images from Open Office XML (OOXML) documents and generates image
 hash similarity graphs that cluster similar images together. The script computes Average Hash of
 each extracted image, then graphs the images if they meet the similarity threshold. The script can
 be used as a technique for visually identifying malware campaigns involving documents. To use the
 script, supply a directory containing OOXML files. If LibreOffice is in your PATH you can optionally convert non-OOXML Word, Excel, PowerPoint and Rich Text File documents to OOXML. The script outputs DOT files that can be exported as images using Graphviz. If Graphviz is in your PATH you can also export
 to an SVG (preferred) or PNG image.

 ## Supported Platforms
 Tested on Ubuntu 18.04 with Python 3.
 
 ## Installation
 First install Graphviz and LibreOffice:
 ``` 
 $ sudo add-apt-repository ppa:libreoffice/ppa
 $ sudo apt update
 $ sudo apt install graphviz libreoffice
 ```
 Afterwards, install the required Python libraries:
 ```
 $ python3 -m pip install -r requirements.txt
 ```
 To view SVG files produced by the script you can use a viewer such as [Inkscape](https://inkscape.org/). Outputting to PNG isn't recommended because the resulting files can be large.
 
 ## Example usage
 Convert documents to OOXML, extract images from the documents, identify images that are similar to the blacklist and then graph images that meet the similarity threshold: 
 ```
 $ graph_similar_document_images.py -f <directory_containing_documents> -c -d <image_hash_signatures.txt> -g -t <min_similarity_threshold> -o <svg|png>
 ```
 ## Help
 ```
usage: graph_similar_document_images.py [-h] -f INPUT_DIR
                                        [-t MIN_SIMILARITY_THRESHOLD]
                                        [-d SIG_FILE] [-g] [-c] [-o {svg,png}]

Usage: graph_similar_document_images.py -f <directory_containing_documents> -d <image_hash_signatures.txt> 
-g -t <min_similarity_threshold> -o <svg|png>

optional arguments:
  -h, --help            show this help message and exit
  -f INPUT_DIR, --files INPUT_DIR
                        Directory to process
  -t MIN_SIMILARITY_THRESHOLD, --threshold MIN_SIMILARITY_THRESHOLD
                        Minimum percentage similarity between images to graph
                        (0 to 100)
  -d SIG_FILE, --detect SIG_FILE
                        Detect mode identifies images that are similiar to a
                        blacklist of known-bad images
  -g, --graph           Graph mode creates a graph of images that meet the
                        similarity threshold
  -c, --convert         Try converting documents to OOXML using LibreOffice
  -o {svg,png}, --output {svg,png}
                        Output image format
 ```
 
 ## Output 
 Example image hash similarity graph (cropped). Here each node is a unique image that is connected by edges to other images that met the similarity threshold.

 <img src="https://github.com/cryptogramfan/Malware-Analysis-Scripts/blob/master/graph_similar_document_images/images/graph_similar_document_images_screenshot_1.png" width="700">
 
 Example CSV output of the script in detect mode, which lists images that match the similarity threshold with the signatures in the blacklist file, [image_hash_signatures.txt](https://github.com/cryptogramfan/Malware-Analysis-Scripts/blob/master/graph_similar_document_images/image_hash_signatures.txt).
 
  <img src="https://github.com/cryptogramfan/Malware-Analysis-Scripts/blob/master/graph_similar_document_images/images/graph_similar_document_images_screenshot_2.png" width="700">
  
 ## License
 Released under the Creative Commons Attribution 4.0 International ([CC BY 4.0](https://creativecommons.org/licenses/by/4.0/)) license.