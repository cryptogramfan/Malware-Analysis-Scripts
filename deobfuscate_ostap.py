#!/usr/bin/env python
#
# A script that deobfuscates Ostap JSE (JScript Encoded) downloaders. The script is based
# on samples from campaigns that delivered TrickBot, analysed in August 2019.
# 
# Usage: 
#
# $ python deobfuscate_ostap.py ostap.jse
# 
# Author...: Alex Holland (@cryptogramfan)
# Date.....: 2019-08-29 
# Version..: 0.0.1
# License..: CC BY 4.0

import sys
import re

values_0 = []
values_1 = []
characters = []

with open(sys.argv[1], 'r') as file:
	input = file.read()
	
	# Find the values of index 0 elements
	array_0 = re.findall("\[0\]=\d+;", input)
	for element in array_0:
		element = re.sub("\[0\]=", "", element) 
		element = re.sub(";", "", element)
		values_0.append(element)
	
	# Convert index 0 elements to integer values
	values_0 = map(int, values_0)
	
	# Find the values of index 1 elements
	array_1 = re.findall("\[1\]=\d+;", input)
	for element in array_1:
		element = re.sub("\[1\]=", "", element) 
		element = re.sub(";", "", element) 
		values_1.append(element)
	
	# Convert index 1 elements to integer values
	values_1 = map(int, values_1)
	
	# Subtract index 0 values from index 1 values
	charcodes = [i - j for i, j in zip(values_1, values_0)]
	
	for charcode in charcodes:
		character = chr(charcode)
		characters.append(character)
		
	characters = ''.join(characters)
	print(characters)
	
	exit(0)